
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Key-Value Store &#8212; Skein 0.8.0+7.g882683d documentation</title>
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="_static/alabaster.css" type="text/css" />
    <script id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/language_data.js"></script>
    <link rel="shortcut icon" href="_static/favicon.ico"/>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Web UI" href="web-ui.html" />
    <link rel="prev" title="Distributing Files" href="distributing-files.html" />
   
  <link rel="stylesheet" href="_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <div class="section" id="key-value-store">
<h1>Key-Value Store<a class="headerlink" href="#key-value-store" title="Permalink to this headline">¶</a></h1>
<p>Every Skein application contains a <a class="reference external" href="https://en.wikipedia.org/wiki/Key-value_database">key-value store</a> running on the application
master. This provides a way for containers to share runtime configuration
parameters (e.g. service addresses), as well as coordinate state between
containers.</p>
<p>Skein takes inspiration from other key-value stores (especially <a class="reference external" href="https://coreos.com/etcd/">etcd</a>), with simplifications and specializations for
YARN as seen fit.</p>
<div class="contents local topic" id="contents">
<ul class="simple">
<li><p><a class="reference internal" href="#overview" id="id2">Overview</a></p></li>
<li><p><a class="reference internal" href="#walkthrough" id="id3">Walkthrough</a></p>
<ul>
<li><p><a class="reference internal" href="#keyvaluestore-basics" id="id4">KeyValueStore Basics</a></p></li>
<li><p><a class="reference internal" href="#iteration" id="id5">Iteration</a></p></li>
<li><p><a class="reference internal" href="#ranges-and-prefixes" id="id6">Ranges and Prefixes</a></p></li>
<li><p><a class="reference internal" href="#additional-methods" id="id7">Additional Methods</a></p></li>
<li><p><a class="reference internal" href="#ownership" id="id8">Ownership</a></p></li>
<li><p><a class="reference internal" href="#transactions" id="id9">Transactions</a></p>
<ul>
<li><p><a class="reference internal" href="#conditions" id="id10">Conditions</a></p></li>
<li><p><a class="reference internal" href="#operations" id="id11">Operations</a></p></li>
<li><p><a class="reference internal" href="#implementing-setdefault" id="id12">Implementing <code class="docutils literal notranslate"><span class="pre">setdefault</span></code></a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#event-streams" id="id13">Event Streams</a></p>
<ul>
<li><p><a class="reference internal" href="#waiting-for-a-single-key" id="id14">Waiting for a Single Key</a></p></li>
</ul>
</li>
</ul>
</li>
<li><p><a class="reference internal" href="#example-atomic-counter" id="id15">Example - Atomic Counter</a></p></li>
</ul>
</div>
<div class="section" id="overview">
<h2><a class="toc-backref" href="#id2">Overview</a><a class="headerlink" href="#overview" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>Keys are UTF-8 encoded strings (<code class="docutils literal notranslate"><span class="pre">str</span></code> in Python), with values as arbitrary
raw bytes (<code class="docutils literal notranslate"><span class="pre">bytes</span></code> in Python).</p></li>
<li><p>The lifetime of a key or keys can be tied to the lifetime of a YARN container
(referred to as the “owner” of the key). When the container completes, all
keys owned by it will be deleted.</p></li>
<li><p>Operations work on single keys, ranges of keys, or keys starting with a
specific prefix (e.g. all keys beginning with <code class="docutils literal notranslate"><span class="pre">&quot;foo&quot;</span></code>).</p></li>
<li><p>Atomic bulk transactions are supported. Several operations can be applied in
a single transaction, potentially based on a set of conditions.</p></li>
<li><p>Clients can subscribe to a range (or ranges) of keys for changes and react
accordingly.</p></li>
</ul>
</div>
<div class="section" id="walkthrough">
<h2><a class="toc-backref" href="#id3">Walkthrough</a><a class="headerlink" href="#walkthrough" title="Permalink to this headline">¶</a></h2>
<p>To illustrate all the functionality provided by the key-value store, and how it
might be useful, the remainder of this page is a complete runnable example. To
start off, we’ll create a test application with a single container that sleeps
forever.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">skein</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">spec</span> <span class="o">=</span> <span class="n">skein</span><span class="o">.</span><span class="n">ApplicationSpec</span><span class="o">.</span><span class="n">from_yaml</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="gp">... </span><span class="s2">name: example</span>
<span class="gp">... </span><span class="s2">services:</span>
<span class="gp">... </span><span class="s2">  sleeper:</span>
<span class="gp">... </span><span class="s2">    resources:</span>
<span class="gp">... </span><span class="s2">      memory: 128 MiB</span>
<span class="gp">... </span><span class="s2">      vcores: 1</span>
<span class="gp">... </span><span class="s2">    script: |</span>
<span class="gp">... </span><span class="s2">      sleep infinity</span>
<span class="gp">... </span><span class="s2">&quot;&quot;&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">client</span> <span class="o">=</span> <span class="n">skein</span><span class="o">.</span><span class="n">Client</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">app</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">submit_and_connect</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>
</pre></div>
</div>
<div class="section" id="keyvaluestore-basics">
<h3><a class="toc-backref" href="#id4">KeyValueStore Basics</a><a class="headerlink" href="#keyvaluestore-basics" title="Permalink to this headline">¶</a></h3>
<p>The <a class="reference internal" href="api.html#skein.kv.KeyValueStore" title="skein.kv.KeyValueStore"><code class="xref py py-class docutils literal notranslate"><span class="pre">KeyValueStore</span></code></a> class implements the standard <code class="docutils literal notranslate"><span class="pre">MutableMapping</span></code>
interface. As mentioned above, all keys must be <code class="docutils literal notranslate"><span class="pre">str</span></code>, and all values must be
<code class="docutils literal notranslate"><span class="pre">bytes</span></code>. All of these methods happen <em>atomically</em> in a single transaction,
meaning there are no race conditions between one client checking state and
another client modifying it.</p>
<p>To start off, let’s put some data on the key-value store. We’ll use the
<a class="reference internal" href="api.html#skein.kv.KeyValueStore.update" title="skein.kv.KeyValueStore.update"><code class="xref py py-func docutils literal notranslate"><span class="pre">KeyValueStore.update()</span></code></a> method to put multiple values in a single
transaction:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Originally the key-value store is empty</span>
<span class="o">&gt;&gt;&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">kv</span><span class="p">)</span>
<span class="mi">0</span>

<span class="c1"># Add some data</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">app</span><span class="o">.</span><span class="n">kv</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;apples&#39;</span><span class="p">:</span> <span class="sa">b</span><span class="s1">&#39;1.22&#39;</span><span class="p">,</span>
                   <span class="s1">&#39;apricots&#39;</span><span class="p">:</span> <span class="sa">b</span><span class="s1">&#39;8.99&#39;</span><span class="p">,</span>
                   <span class="s1">&#39;bananas&#39;</span><span class="p">:</span> <span class="sa">b</span><span class="s1">&#39;0.56&#39;</span><span class="p">,</span>
                   <span class="s1">&#39;oranges&#39;</span><span class="p">:</span> <span class="sa">b</span><span class="s1">&#39;7.96&#39;</span><span class="p">})</span>

<span class="c1"># Now there are 4 items</span>
<span class="o">&gt;&gt;&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">kv</span><span class="p">)</span>
<span class="mi">4</span>
</pre></div>
</div>
<p>As with other mutable mappings, you can get, set, and delete values using the
standard interface:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Get the value for &#39;apples&#39;</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">app</span><span class="o">.</span><span class="n">kv</span><span class="p">[</span><span class="s1">&#39;apples&#39;</span><span class="p">]</span>
<span class="sa">b</span><span class="s1">&#39;1.22&#39;</span>

<span class="c1"># Add a new value for &#39;grapes&#39;</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">app</span><span class="o">.</span><span class="n">kv</span><span class="p">[</span><span class="s1">&#39;grapes&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;2.88&#39;</span>

<span class="c1"># Check if &#39;grapes&#39; is present</span>
<span class="o">&gt;&gt;&gt;</span> <span class="s1">&#39;grapes&#39;</span> <span class="ow">in</span> <span class="n">app</span><span class="o">.</span><span class="n">kv</span>
<span class="kc">True</span>

<span class="c1"># Update the value for &#39;grapes&#39;</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">app</span><span class="o">.</span><span class="n">kv</span><span class="p">[</span><span class="s1">&#39;grapes&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;2.61&#39;</span>

<span class="c1"># Delete &#39;grapes&#39;</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">del</span> <span class="n">app</span><span class="o">.</span><span class="n">kv</span><span class="p">[</span><span class="s1">&#39;grapes&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="section" id="iteration">
<h3><a class="toc-backref" href="#id5">Iteration</a><a class="headerlink" href="#iteration" title="Permalink to this headline">¶</a></h3>
<p>Since <a class="reference internal" href="api.html#skein.kv.KeyValueStore" title="skein.kv.KeyValueStore"><code class="xref py py-class docutils literal notranslate"><span class="pre">KeyValueStore</span></code></a> supports the <code class="docutils literal notranslate"><span class="pre">MutableMapping</span></code> interface, things
like iterating over the keys work as expected. The iteration order is
alphabetical based on keys, as the mapping is sorted internally (more on that
later).</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="nb">list</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">kv</span><span class="p">)</span>
<span class="go">[&#39;apples&#39;, &#39;apricots&#39;, &#39;bananas&#39;, &#39;oranges&#39;]</span>
</pre></div>
</div>
<p>However, sometimes using the standard iteration based protocols can unsafe or
inefficient. Since the key-value store is a shared mapping with potentially
many clients making changes concurrently, you need need to think about
race-conditions when passing the key-value store to functions that might make
use of iteration in a potentially unsafe way. For example, calling <code class="docutils literal notranslate"><span class="pre">dict</span></code> on
the key-value store object works as expected, but is not the best way to get
all key-value pairs for two reasons:</p>
<ul>
<li><p>Interally, <code class="docutils literal notranslate"><span class="pre">dict</span></code> iterates over the keys in the provided mapping. It’s
implemented something like:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">dict</span><span class="p">(</span><span class="n">mapping</span><span class="p">):</span>
    <span class="n">out</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">mapping</span><span class="p">:</span>
        <span class="n">out</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapping</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">out</span>
</pre></div>
</div>
<p>Since iterating over the keys and copying out their values happens over
multiple operations, other clients may have changed the key-value store
between operations, meaning the output <code class="docutils literal notranslate"><span class="pre">dict</span></code> may represent an inconsistent
state.</p>
</li>
<li><p>Additionally, calling <code class="docutils literal notranslate"><span class="pre">dict</span></code> on the mapping results in multiple operations,
reducing efficiency as it makes more calls than required.</p></li>
</ul>
<p>For these reasons, it’s better to use methods that operate on <a class="reference internal" href="#ranges-and-prefixes">Ranges and
Prefixes</a> instead:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="nb">dict</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">kv</span><span class="p">)</span>  <span class="c1"># unsafe and inefficient</span>
<span class="go">{&#39;apples&#39;: b&#39;1.22&#39;,</span>
<span class="go"> &#39;apricots&#39;: b&#39;8.99&#39;,</span>
<span class="go"> &#39;bananas&#39;: b&#39;0.56&#39;,</span>
<span class="go"> &#39;oranges&#39;: b&#39;7.96&#39;}</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">app</span><span class="o">.</span><span class="n">kv</span><span class="o">.</span><span class="n">get_range</span><span class="p">()</span>  <span class="c1"># safe and efficient</span>
<span class="go">OrderedDict([(&#39;apples&#39;, b&#39;1.22&#39;),</span>
<span class="go">             (&#39;apricots&#39;, b&#39;8.99&#39;),</span>
<span class="go">             (&#39;bananas&#39;, b&#39;0.56&#39;),</span>
<span class="go">             (&#39;oranges&#39;, b&#39;7.96&#39;)])</span>
</pre></div>
</div>
</div>
<div class="section" id="ranges-and-prefixes">
<h3><a class="toc-backref" href="#id6">Ranges and Prefixes</a><a class="headerlink" href="#ranges-and-prefixes" title="Permalink to this headline">¶</a></h3>
<p>Key-value pairs are sorted internally, allowing for efficient operations on
ranges of keys. Ranges are start <em>inclusive</em> and end <em>exclusive</em>. If start or
end are unspecified, the range is unbounded on that side. Many methods have
range versions, allowing for bulk operations in a single call. Operations on
keys starting with a certain “prefix” are also supported. These are special
cases of range operations (since <code class="docutils literal notranslate"><span class="pre">get_prefix(&quot;abc&quot;)</span></code> is equivalent to
<code class="docutils literal notranslate"><span class="pre">get_range(start=&quot;abc&quot;,</span> <span class="pre">end=&quot;abd&quot;)</span></code>).</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Lookup all keys starting with &quot;ap&quot;</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">app</span><span class="o">.</span><span class="n">kv</span><span class="o">.</span><span class="n">get_prefix</span><span class="p">(</span><span class="s2">&quot;ap&quot;</span><span class="p">)</span>
<span class="n">OrderedDict</span><span class="p">([(</span><span class="s1">&#39;apples&#39;</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;1.22&#39;</span><span class="p">),</span>
             <span class="p">(</span><span class="s1">&#39;apricots&#39;</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;8.99&#39;</span><span class="p">)])</span>

<span class="c1"># Lookup all keys in [&quot;apricots&quot;, &quot;oranges&quot;)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">app</span><span class="o">.</span><span class="n">kv</span><span class="o">.</span><span class="n">get_range</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="s2">&quot;apricots&quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;oranges&quot;</span><span class="p">)</span>
<span class="n">OrderedDict</span><span class="p">([(</span><span class="s1">&#39;apricots&#39;</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;8.99&#39;</span><span class="p">),</span>
             <span class="p">(</span><span class="s1">&#39;bananas&#39;</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;0.56&#39;</span><span class="p">)])</span>

<span class="c1"># Pop all keys after &quot;m&quot;</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">removed</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">kv</span><span class="o">.</span><span class="n">pop_range</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="s2">&quot;m&quot;</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">removed</span>
<span class="n">OrderedDict</span><span class="p">([(</span><span class="s1">&#39;oranges&#39;</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;7.96&#39;</span><span class="p">)])</span>

<span class="o">&gt;&gt;&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">kv</span><span class="p">)</span>  <span class="c1"># the key was removed</span>
<span class="mi">3</span>

<span class="c1"># Put it back</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">app</span><span class="o">.</span><span class="n">kv</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">removed</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">kv</span><span class="p">)</span>
<span class="mi">4</span>
</pre></div>
</div>
</div>
<div class="section" id="additional-methods">
<h3><a class="toc-backref" href="#id7">Additional Methods</a><a class="headerlink" href="#additional-methods" title="Permalink to this headline">¶</a></h3>
<p>Besides the <code class="docutils literal notranslate"><span class="pre">MutableMapping</span></code> interface, the <a class="reference internal" href="api.html#skein.kv.KeyValueStore" title="skein.kv.KeyValueStore"><code class="xref py py-class docutils literal notranslate"><span class="pre">KeyValueStore</span></code></a> class
provides a larger set of methods for common operations. Each of these runs as a
single atomic transaction, and most have variations for a single key, a range
of keys, or a key prefix.</p>
<table class="longtable docutils align-default">
<colgroup>
<col style="width: 10%" />
<col style="width: 90%" />
</colgroup>
<tbody>
<tr class="row-odd"><td><p><a class="reference internal" href="api.html#skein.kv.KeyValueStore.count" title="skein.kv.KeyValueStore.count"><code class="xref py py-obj docutils literal notranslate"><span class="pre">KeyValueStore.count</span></code></a>([start, end, prefix])</p></td>
<td><p>Count keys in the key-value store.</p></td>
</tr>
<tr class="row-even"><td><p><a class="reference internal" href="api.html#skein.kv.KeyValueStore.list_keys" title="skein.kv.KeyValueStore.list_keys"><code class="xref py py-obj docutils literal notranslate"><span class="pre">KeyValueStore.list_keys</span></code></a>([start, end, prefix])</p></td>
<td><p>Get a list of keys in the key-value store.</p></td>
</tr>
<tr class="row-odd"><td><p><a class="reference internal" href="api.html#skein.kv.KeyValueStore.exists" title="skein.kv.KeyValueStore.exists"><code class="xref py py-obj docutils literal notranslate"><span class="pre">KeyValueStore.exists</span></code></a>(key)</p></td>
<td><p>Check if a key exists in the key-value store.</p></td>
</tr>
<tr class="row-even"><td><p><a class="reference internal" href="api.html#skein.kv.KeyValueStore.missing" title="skein.kv.KeyValueStore.missing"><code class="xref py py-obj docutils literal notranslate"><span class="pre">KeyValueStore.missing</span></code></a>(key)</p></td>
<td><p>Check if a key is not in the key-value store.</p></td>
</tr>
<tr class="row-odd"><td><p><a class="reference internal" href="api.html#skein.kv.KeyValueStore.get" title="skein.kv.KeyValueStore.get"><code class="xref py py-obj docutils literal notranslate"><span class="pre">KeyValueStore.get</span></code></a>(key[, default, return_owner])</p></td>
<td><p>Get the value associated with a single key.</p></td>
</tr>
<tr class="row-even"><td><p><a class="reference internal" href="api.html#skein.kv.KeyValueStore.get_prefix" title="skein.kv.KeyValueStore.get_prefix"><code class="xref py py-obj docutils literal notranslate"><span class="pre">KeyValueStore.get_prefix</span></code></a>(prefix[, return_owner])</p></td>
<td><p>Get all key-value pairs whose keys start with <code class="docutils literal notranslate"><span class="pre">prefix</span></code>.</p></td>
</tr>
<tr class="row-odd"><td><p><a class="reference internal" href="api.html#skein.kv.KeyValueStore.get_range" title="skein.kv.KeyValueStore.get_range"><code class="xref py py-obj docutils literal notranslate"><span class="pre">KeyValueStore.get_range</span></code></a>([start, end, …])</p></td>
<td><p>Get a range of keys.</p></td>
</tr>
<tr class="row-even"><td><p><a class="reference internal" href="api.html#skein.kv.KeyValueStore.pop" title="skein.kv.KeyValueStore.pop"><code class="xref py py-obj docutils literal notranslate"><span class="pre">KeyValueStore.pop</span></code></a>(key[, default, return_owner])</p></td>
<td><p>Remove a single key and return its corresponding value.</p></td>
</tr>
<tr class="row-odd"><td><p><a class="reference internal" href="api.html#skein.kv.KeyValueStore.pop_prefix" title="skein.kv.KeyValueStore.pop_prefix"><code class="xref py py-obj docutils literal notranslate"><span class="pre">KeyValueStore.pop_prefix</span></code></a>(prefix[, return_owner])</p></td>
<td><p>Remove all key-value pairs whose keys start with <code class="docutils literal notranslate"><span class="pre">prefix</span></code>, and return their corresponding values.</p></td>
</tr>
<tr class="row-even"><td><p><a class="reference internal" href="api.html#skein.kv.KeyValueStore.pop_range" title="skein.kv.KeyValueStore.pop_range"><code class="xref py py-obj docutils literal notranslate"><span class="pre">KeyValueStore.pop_range</span></code></a>([start, end, …])</p></td>
<td><p>Remove a range of keys and return their corresponding values.</p></td>
</tr>
<tr class="row-odd"><td><p><a class="reference internal" href="api.html#skein.kv.KeyValueStore.discard" title="skein.kv.KeyValueStore.discard"><code class="xref py py-obj docutils literal notranslate"><span class="pre">KeyValueStore.discard</span></code></a>(key)</p></td>
<td><p>Discard a single key.</p></td>
</tr>
<tr class="row-even"><td><p><a class="reference internal" href="api.html#skein.kv.KeyValueStore.discard_prefix" title="skein.kv.KeyValueStore.discard_prefix"><code class="xref py py-obj docutils literal notranslate"><span class="pre">KeyValueStore.discard_prefix</span></code></a>(prefix[, …])</p></td>
<td><p>Discard all key-value pairs whose keys start with <code class="docutils literal notranslate"><span class="pre">prefix</span></code>.</p></td>
</tr>
<tr class="row-odd"><td><p><a class="reference internal" href="api.html#skein.kv.KeyValueStore.discard_range" title="skein.kv.KeyValueStore.discard_range"><code class="xref py py-obj docutils literal notranslate"><span class="pre">KeyValueStore.discard_range</span></code></a>([start, end, …])</p></td>
<td><p>Discard a range of keys.</p></td>
</tr>
<tr class="row-even"><td><p><a class="reference internal" href="api.html#skein.kv.KeyValueStore.put" title="skein.kv.KeyValueStore.put"><code class="xref py py-obj docutils literal notranslate"><span class="pre">KeyValueStore.put</span></code></a>(key[, value, owner])</p></td>
<td><p>Assign a value and/or owner for a single key.</p></td>
</tr>
<tr class="row-odd"><td><p><a class="reference internal" href="api.html#skein.kv.KeyValueStore.swap" title="skein.kv.KeyValueStore.swap"><code class="xref py py-obj docutils literal notranslate"><span class="pre">KeyValueStore.swap</span></code></a>(key[, value, owner, …])</p></td>
<td><p>Assign a new value and/or owner for a single key, and return the previous value.</p></td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="ownership">
<h3><a class="toc-backref" href="#id8">Ownership</a><a class="headerlink" href="#ownership" title="Permalink to this headline">¶</a></h3>
<p>Skein’s key-value store provides a key ownership model. This allows the
lifetime of a key or keys to be tied to the lifetime of a YARN container
(referred to as the “owner” of the key). When the container finishes (whether
after success, failure, or being killed by the user), any keys owned by that
container are deleted. This can be useful for tracking container lifetimes, or
implementing robust locks that are released when a container exits.</p>
<p>Owners are specified as <em>skein</em> container ids. These are different than their
YARN counterparts, and are strings of the form
<code class="docutils literal notranslate"><span class="pre">{service-name}_{instance-number}</span></code> (e.g. <code class="docutils literal notranslate"><span class="pre">myservice_1</span></code>). Container ids can
be obtained in a few ways:</p>
<ul>
<li><p>From a <code class="xref py py-class docutils literal notranslate"><span class="pre">Container</span></code> object:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">id</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">app</span><span class="o">.</span><span class="n">get_containers</span><span class="p">()]</span>
<span class="go">[&#39;sleeper_0&#39;]</span>
</pre></div>
</div>
</li>
<li><p>When running code on a container, the executing container id is available in
the <a class="reference internal" href="api.html#skein.properties" title="skein.properties"><code class="xref py py-data docutils literal notranslate"><span class="pre">skein.properties</span></code></a> object:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Example of code executing in a container</span>
<span class="o">&gt;&gt;&gt;</span> <span class="kn">import</span> <span class="nn">skein</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">skein</span><span class="o">.</span><span class="n">properties</span><span class="o">.</span><span class="n">container_id</span>
<span class="s1">&#39;myservice_10&#39;</span>
</pre></div>
</div>
</li>
</ul>
<p>To set or change the owner for a key, pass a container id to
<code class="xref py py-func docutils literal notranslate"><span class="pre">KeyVaueStore.put()</span></code> or <a class="reference internal" href="api.html#skein.kv.KeyValueStore.swap" title="skein.kv.KeyValueStore.swap"><code class="xref py py-func docutils literal notranslate"><span class="pre">KeyValueStore.swap()</span></code></a> via the <code class="docutils literal notranslate"><span class="pre">owner</span></code>
keyword. Likewise the owner of a key or keys can be retrieved using the normal
<code class="docutils literal notranslate"><span class="pre">get</span></code> methods by providing <code class="docutils literal notranslate"><span class="pre">return_owner=True</span></code>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># First scale up the &#39;sleeper&#39; service to 2 containers</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">app</span><span class="o">.</span><span class="n">scale</span><span class="p">(</span><span class="s1">&#39;sleeper&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="p">[</span><span class="n">Container</span><span class="o">&lt;</span><span class="n">service_name</span><span class="o">=</span><span class="s1">&#39;sleeper&#39;</span><span class="p">,</span> <span class="n">instance</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">state</span><span class="o">=</span><span class="n">REQUESTED</span><span class="o">&gt;</span><span class="p">]</span>

<span class="c1"># Create a new key &#39;grapes&#39;, and set the owner to &#39;sleeper_0&#39;</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">app</span><span class="o">.</span><span class="n">kv</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s1">&#39;grapes&#39;</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;2.88&#39;</span><span class="p">,</span> <span class="n">owner</span><span class="o">=</span><span class="s1">&#39;sleeper_0&#39;</span><span class="p">)</span>

<span class="c1"># Get the full value &amp; owner record for &#39;grapes&#39;</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">app</span><span class="o">.</span><span class="n">kv</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;grapes&#39;</span><span class="p">,</span> <span class="n">return_owner</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">ValueOwnerPair</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="sa">b</span><span class="s1">&#39;2.88&#39;</span><span class="p">,</span> <span class="n">owner</span><span class="o">=</span><span class="s1">&#39;sleeper_0&#39;</span><span class="p">)</span>

<span class="c1"># Change the value, owner stays the same</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">app</span><span class="o">.</span><span class="n">kv</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s1">&#39;grapes&#39;</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;2.61&#39;</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">app</span><span class="o">.</span><span class="n">kv</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;grapes&#39;</span><span class="p">,</span> <span class="n">return_owner</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">ValueOwnerPair</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="sa">b</span><span class="s1">&#39;2.61&#39;</span><span class="p">,</span> <span class="n">owner</span><span class="o">=</span><span class="s1">&#39;sleeper_0&#39;</span><span class="p">)</span>

<span class="c1"># Change the owner, value stays the same</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">app</span><span class="o">.</span><span class="n">kv</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s1">&#39;grapes&#39;</span><span class="p">,</span> <span class="n">owner</span><span class="o">=</span><span class="s1">&#39;sleeper_1&#39;</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">app</span><span class="o">.</span><span class="n">kv</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;grapes&#39;</span><span class="p">,</span> <span class="n">return_owner</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">ValueOwnerPair</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="sa">b</span><span class="s1">&#39;2.61&#39;</span><span class="p">,</span> <span class="n">owner</span><span class="o">=</span><span class="s1">&#39;sleeper_1&#39;</span><span class="p">)</span>

<span class="c1"># To clear the owner, set to None</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">app</span><span class="o">.</span><span class="n">kv</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s1">&#39;grapes&#39;</span><span class="p">,</span> <span class="n">owner</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">app</span><span class="o">.</span><span class="n">kv</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;grapes&#39;</span><span class="p">,</span> <span class="n">return_owner</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">ValueOwnerPair</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="sa">b</span><span class="s1">&#39;2.61&#39;</span><span class="p">,</span> <span class="n">owner</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
</pre></div>
</div>
<p>When a container exits, all of its owned keys (if any) are deleted.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set the owner of grapes to &#39;sleeper_1&#39;</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">app</span><span class="o">.</span><span class="n">kv</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s1">&#39;grapes&#39;</span><span class="p">,</span> <span class="n">owner</span><span class="o">=</span><span class="s1">&#39;sleeper_1&#39;</span><span class="p">)</span>

<span class="o">&gt;&gt;&gt;</span> <span class="s1">&#39;grapes&#39;</span> <span class="ow">in</span> <span class="n">app</span><span class="o">.</span><span class="n">kv</span>
<span class="kc">True</span>

<span class="c1"># Kill the &#39;sleeper_1&#39; container</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">app</span><span class="o">.</span><span class="n">kill_container</span><span class="p">(</span><span class="s1">&#39;sleeper_1&#39;</span><span class="p">)</span>

<span class="o">&gt;&gt;&gt;</span> <span class="s1">&#39;grapes&#39;</span> <span class="ow">in</span> <span class="n">app</span><span class="o">.</span><span class="n">kv</span>
<span class="kc">False</span>
</pre></div>
</div>
</div>
<div class="section" id="transactions">
<h3><a class="toc-backref" href="#id9">Transactions</a><a class="headerlink" href="#transactions" title="Permalink to this headline">¶</a></h3>
<p>Skein provides support for applying several operations in a single transaction,
potentially based on a set of conditions. This is useful for preventing race
conditions.</p>
<p>For example, say you want to get the value of a key if it exists, and if it
doesn’t you want to set the value to a default and then return the default
(this is the <code class="docutils literal notranslate"><span class="pre">setdefault</span></code> method from the <code class="docutils literal notranslate"><span class="pre">MutableMapping</span></code> interface).</p>
<p>A naive implementation would suffer from a couple race conditions:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">naive_setdefault</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">default</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A naive implementation of MutableMapping.setdefault&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
        <span class="c1"># Race condition 1: key could be deleted by a different client</span>
        <span class="c1"># between the contains check and the getitem</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Race condition 2: key could be created by a different client</span>
        <span class="c1"># between the contains check and the setitem</span>
        <span class="bp">self</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">default</span>
        <span class="k">return</span> <span class="n">default</span>
</pre></div>
</div>
<p>The <a class="reference internal" href="api.html#skein.kv.KeyValueStore.transaction" title="skein.kv.KeyValueStore.transaction"><code class="xref py py-func docutils literal notranslate"><span class="pre">KeyValueStore.transaction()</span></code></a> method exists to solve this problem. This
takes 3 parameters:</p>
<ul class="simple">
<li><p>A sequence of <code class="xref py py-class docutils literal notranslate"><span class="pre">Condition</span></code> objects to evaluate together. The
conditional expression succeeds if all conditions evaluate to True, and fails
otherwise. If no conditions are provided the conditional expression also
succeeds.</p></li>
<li><p>A sequence of <code class="xref py py-class docutils literal notranslate"><span class="pre">Operation</span></code> objects to apply if all conditions evaluate
to True.</p></li>
<li><p>A sequence of <code class="xref py py-class docutils literal notranslate"><span class="pre">Operation</span></code> objects to apply if any condition evaluates
to False.</p></li>
</ul>
<div class="section" id="conditions">
<h4><a class="toc-backref" href="#id10">Conditions</a><a class="headerlink" href="#conditions" title="Permalink to this headline">¶</a></h4>
<p><code class="xref py py-class docutils literal notranslate"><span class="pre">Condition</span></code> objects are prechecks on the state of the key-value store.
They can check for the existance or absence of a key, as well as comparisons
(equality or order) on the value or owner corresponding with a key.</p>
<table class="longtable docutils align-default">
<colgroup>
<col style="width: 10%" />
<col style="width: 90%" />
</colgroup>
<tbody>
<tr class="row-odd"><td><p><a class="reference internal" href="api.html#skein.kv.exists" title="skein.kv.exists"><code class="xref py py-obj docutils literal notranslate"><span class="pre">exists</span></code></a>(key)</p></td>
<td><p>A request to check if a key exists in the key-value store.</p></td>
</tr>
<tr class="row-even"><td><p><a class="reference internal" href="api.html#skein.kv.missing" title="skein.kv.missing"><code class="xref py py-obj docutils literal notranslate"><span class="pre">missing</span></code></a>(key)</p></td>
<td><p>A request to check if a key is not in the key-value store.</p></td>
</tr>
<tr class="row-odd"><td><p><a class="reference internal" href="api.html#skein.kv.value" title="skein.kv.value"><code class="xref py py-obj docutils literal notranslate"><span class="pre">value</span></code></a>(key)</p></td>
<td><p>Represents the value for a key, for use in transaction conditions.</p></td>
</tr>
<tr class="row-even"><td><p><a class="reference internal" href="api.html#skein.kv.owner" title="skein.kv.owner"><code class="xref py py-obj docutils literal notranslate"><span class="pre">owner</span></code></a>(key)</p></td>
<td><p>Represents the owner for a key, for use in transaction conditions.</p></td>
</tr>
<tr class="row-odd"><td><p><a class="reference internal" href="api.html#skein.kv.comparison" title="skein.kv.comparison"><code class="xref py py-obj docutils literal notranslate"><span class="pre">comparison</span></code></a>(key, field, operator, rhs)</p></td>
<td><p>A comparison of the value or owner for a specified key.</p></td>
</tr>
</tbody>
</table>
<p>A few examples</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">skein</span> <span class="kn">import</span> <span class="n">kv</span>

<span class="go"># A condition to check if &#39;grapes&#39; exists</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">kv</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s1">&#39;grapes&#39;</span><span class="p">)</span>
<span class="go">exists(&#39;grapes&#39;)</span>

<span class="go"># A condition to check if the value of &#39;apples&#39; is b&#39;123&#39;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">kv</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="s1">&#39;apples&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="sa">b</span><span class="s1">&#39;123&#39;</span>
<span class="go">value(&#39;apples&#39;) == b&#39;123&#39;</span>

<span class="go"># A condition to check if the value of &#39;apples&#39; is greater than b&#39;000&#39;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">kv</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="s1">&#39;apples&#39;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="sa">b</span><span class="s1">&#39;000&#39;</span>
<span class="go">value(&#39;apples&#39;) &gt; b&#39;000&#39;</span>

<span class="go"># A condition to check if &#39;apples&#39; has an owner</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">kv</span><span class="o">.</span><span class="n">owner</span><span class="p">(</span><span class="s1">&#39;apples&#39;</span><span class="p">)</span> <span class="o">!=</span> <span class="kc">None</span>
<span class="go">owner(&#39;apples&#39;) != None</span>
</pre></div>
</div>
</div>
<div class="section" id="operations">
<h4><a class="toc-backref" href="#id11">Operations</a><a class="headerlink" href="#operations" title="Permalink to this headline">¶</a></h4>
<p><code class="xref py py-class docutils literal notranslate"><span class="pre">Operation</span></code> objects are operations to apply to the key-value store.
These coincide with the <a class="reference internal" href="#additional-methods">Additional Methods</a> described above - for every
method on the <a class="reference internal" href="api.html#skein.kv.KeyValueStore" title="skein.kv.KeyValueStore"><code class="xref py py-class docutils literal notranslate"><span class="pre">KeyValueStore</span></code></a> there is an identical operation in the
<code class="xref py py-mod docutils literal notranslate"><span class="pre">skein.kv</span></code> namespace.</p>
<table class="longtable docutils align-default">
<colgroup>
<col style="width: 10%" />
<col style="width: 90%" />
</colgroup>
<tbody>
<tr class="row-odd"><td><p><a class="reference internal" href="api.html#id0" title="skein.kv.count"><code class="xref py py-obj docutils literal notranslate"><span class="pre">count</span></code></a>([start, end, prefix])</p></td>
<td><p>A request to count keys in the key-value store.</p></td>
</tr>
<tr class="row-even"><td><p><a class="reference internal" href="api.html#skein.kv.list_keys" title="skein.kv.list_keys"><code class="xref py py-obj docutils literal notranslate"><span class="pre">list_keys</span></code></a>([start, end, prefix])</p></td>
<td><p>A request to get a list of keys in the key-value store.</p></td>
</tr>
<tr class="row-odd"><td><p><a class="reference internal" href="api.html#skein.kv.exists" title="skein.kv.exists"><code class="xref py py-obj docutils literal notranslate"><span class="pre">exists</span></code></a>(key)</p></td>
<td><p>A request to check if a key exists in the key-value store.</p></td>
</tr>
<tr class="row-even"><td><p><a class="reference internal" href="api.html#skein.kv.missing" title="skein.kv.missing"><code class="xref py py-obj docutils literal notranslate"><span class="pre">missing</span></code></a>(key)</p></td>
<td><p>A request to check if a key is not in the key-value store.</p></td>
</tr>
<tr class="row-odd"><td><p><a class="reference internal" href="api.html#skein.kv.get" title="skein.kv.get"><code class="xref py py-obj docutils literal notranslate"><span class="pre">get</span></code></a>(key[, default, return_owner])</p></td>
<td><p>A request to get the value associated with a single key.</p></td>
</tr>
<tr class="row-even"><td><p><a class="reference internal" href="api.html#skein.kv.get_prefix" title="skein.kv.get_prefix"><code class="xref py py-obj docutils literal notranslate"><span class="pre">get_prefix</span></code></a>(prefix[, return_owner])</p></td>
<td><p>A request to get all key-value pairs whose keys start with <code class="docutils literal notranslate"><span class="pre">prefix</span></code>.</p></td>
</tr>
<tr class="row-odd"><td><p><a class="reference internal" href="api.html#skein.kv.get_range" title="skein.kv.get_range"><code class="xref py py-obj docutils literal notranslate"><span class="pre">get_range</span></code></a>([start, end, return_owner])</p></td>
<td><p>A request to get a range of keys.</p></td>
</tr>
<tr class="row-even"><td><p><a class="reference internal" href="api.html#skein.kv.pop" title="skein.kv.pop"><code class="xref py py-obj docutils literal notranslate"><span class="pre">pop</span></code></a>(key[, default, return_owner])</p></td>
<td><p>A request to remove a single key and return its corresponding value.</p></td>
</tr>
<tr class="row-odd"><td><p><a class="reference internal" href="api.html#skein.kv.pop_prefix" title="skein.kv.pop_prefix"><code class="xref py py-obj docutils literal notranslate"><span class="pre">pop_prefix</span></code></a>(prefix[, return_owner])</p></td>
<td><p>A request to remove all key-value pairs whose keys start with <code class="docutils literal notranslate"><span class="pre">prefix</span></code>, and return their corresponding values.</p></td>
</tr>
<tr class="row-even"><td><p><a class="reference internal" href="api.html#skein.kv.pop_range" title="skein.kv.pop_range"><code class="xref py py-obj docutils literal notranslate"><span class="pre">pop_range</span></code></a>([start, end, return_owner])</p></td>
<td><p>A request to remove a range of keys and return their corresponding values.</p></td>
</tr>
<tr class="row-odd"><td><p><a class="reference internal" href="api.html#skein.kv.discard" title="skein.kv.discard"><code class="xref py py-obj docutils literal notranslate"><span class="pre">discard</span></code></a>(key)</p></td>
<td><p>A request to discard a single key.</p></td>
</tr>
<tr class="row-even"><td><p><a class="reference internal" href="api.html#skein.kv.discard_prefix" title="skein.kv.discard_prefix"><code class="xref py py-obj docutils literal notranslate"><span class="pre">discard_prefix</span></code></a>(prefix[, return_keys])</p></td>
<td><p>A request to discard all key-value pairs whose keys start with <code class="docutils literal notranslate"><span class="pre">prefix</span></code>.</p></td>
</tr>
<tr class="row-odd"><td><p><a class="reference internal" href="api.html#skein.kv.discard_range" title="skein.kv.discard_range"><code class="xref py py-obj docutils literal notranslate"><span class="pre">discard_range</span></code></a>([start, end, return_keys])</p></td>
<td><p>A request to discard a range of keys.</p></td>
</tr>
<tr class="row-even"><td><p><a class="reference internal" href="api.html#skein.kv.put" title="skein.kv.put"><code class="xref py py-obj docutils literal notranslate"><span class="pre">put</span></code></a>(key[, value, owner])</p></td>
<td><p>A request to assign a value and/or owner for a single key.</p></td>
</tr>
<tr class="row-odd"><td><p><a class="reference internal" href="api.html#skein.kv.swap" title="skein.kv.swap"><code class="xref py py-obj docutils literal notranslate"><span class="pre">swap</span></code></a>(key[, value, owner, return_owner])</p></td>
<td><p>A request to assign a new value and/or owner for a single key, and return the previous value.</p></td>
</tr>
</tbody>
</table>
<p>A few examples</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">skein</span> <span class="kn">import</span> <span class="n">kv</span>

<span class="go"># An operation to get the value of &#39;apples&#39;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">kv</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;apples&#39;</span><span class="p">)</span>
<span class="go">get(&#39;apples&#39;, default=None, return_owner=False)</span>

<span class="go"># An operation to set the value of &#39;grapes&#39; to b&#39;123&#39;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">kv</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s1">&#39;grapes&#39;</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;123&#39;</span><span class="p">)</span>
<span class="go">put(&#39;grapes&#39;, value=b&#39;123&#39;, owner=no_change)</span>
</pre></div>
</div>
</div>
<div class="section" id="implementing-setdefault">
<h4><a class="toc-backref" href="#id12">Implementing <code class="docutils literal notranslate"><span class="pre">setdefault</span></code></a><a class="headerlink" href="#implementing-setdefault" title="Permalink to this headline">¶</a></h4>
<p>Using the above, we can do an atomic implementation of <code class="docutils literal notranslate"><span class="pre">setdefault</span></code>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">skein</span> <span class="kn">import</span> <span class="n">kv</span>

<span class="k">def</span> <span class="nf">setdefault</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">default</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A safe, atomic implementation of MutableMapping.setdefault&quot;&quot;&quot;</span>
    <span class="c1"># If the key exists, get the value, otherwise set the value to default</span>
    <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">transaction</span><span class="p">(</span><span class="n">conditions</span><span class="o">=</span><span class="p">[</span><span class="n">kv</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">key</span><span class="p">)],</span>
                           <span class="n">on_success</span><span class="o">=</span><span class="p">[</span><span class="n">kv</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)],</span>
                           <span class="n">on_failure</span><span class="o">=</span><span class="p">[</span><span class="n">kv</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">default</span><span class="p">)])</span>
    <span class="k">if</span> <span class="n">res</span><span class="o">.</span><span class="n">succeeded</span><span class="p">:</span>
        <span class="c1"># Condition succeeded, return result of get</span>
        <span class="k">return</span> <span class="n">res</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Condition failed, key didn&#39;t exist. Return default</span>
        <span class="k">return</span> <span class="n">default</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="event-streams">
<h3><a class="toc-backref" href="#id13">Event Streams</a><a class="headerlink" href="#event-streams" title="Permalink to this headline">¶</a></h3>
<p>Skein provides a way for clients to subscribe to a range (or ranges) of keys
for changes. This can be useful for waiting for certain keys to be set, or
creating larger abstractions for coordinating workers like locks or semaphores.</p>
<table class="longtable docutils align-default">
<colgroup>
<col style="width: 10%" />
<col style="width: 90%" />
</colgroup>
<tbody>
<tr class="row-odd"><td><p><a class="reference internal" href="api.html#skein.kv.KeyValueStore.event_queue" title="skein.kv.KeyValueStore.event_queue"><code class="xref py py-obj docutils literal notranslate"><span class="pre">KeyValueStore.event_queue</span></code></a>()</p></td>
<td><p>Create a new EventQueue subscribed to no events.</p></td>
</tr>
<tr class="row-even"><td><p><a class="reference internal" href="api.html#skein.kv.KeyValueStore.events" title="skein.kv.KeyValueStore.events"><code class="xref py py-obj docutils literal notranslate"><span class="pre">KeyValueStore.events</span></code></a>([event_filter, key, …])</p></td>
<td><p>Shorthand for creating an EventQueue and adding a single filter.</p></td>
</tr>
<tr class="row-odd"><td><p><a class="reference internal" href="api.html#skein.kv.EventQueue" title="skein.kv.EventQueue"><code class="xref py py-obj docutils literal notranslate"><span class="pre">EventQueue</span></code></a>(kv)</p></td>
<td><p>A queue of events on the key-value store.</p></td>
</tr>
<tr class="row-even"><td><p><a class="reference internal" href="api.html#skein.kv.EventFilter" title="skein.kv.EventFilter"><code class="xref py py-obj docutils literal notranslate"><span class="pre">EventFilter</span></code></a>([key, prefix, start, end, …])</p></td>
<td><p>An event filter.</p></td>
</tr>
<tr class="row-odd"><td><p><a class="reference internal" href="api.html#skein.kv.Event" title="skein.kv.Event"><code class="xref py py-obj docutils literal notranslate"><span class="pre">Event</span></code></a>(key, result, event_type, event_filter)</p></td>
<td><p>An event in the key-value store.</p></td>
</tr>
</tbody>
</table>
<p>To subscribe to an event stream you can use either
<a class="reference internal" href="api.html#skein.kv.KeyValueStore.event_queue" title="skein.kv.KeyValueStore.event_queue"><code class="xref py py-func docutils literal notranslate"><span class="pre">KeyValueStore.event_queue()</span></code></a> and <a class="reference internal" href="api.html#skein.kv.KeyValueStore.events" title="skein.kv.KeyValueStore.events"><code class="xref py py-func docutils literal notranslate"><span class="pre">KeyValueStore.events()</span></code></a> (the latter
is shorthand for creation and subscription). Both methods return an instance of
<a class="reference internal" href="api.html#skein.kv.EventQueue" title="skein.kv.EventQueue"><code class="xref py py-func docutils literal notranslate"><span class="pre">EventQueue()</span></code></a>, an object similar to <code class="docutils literal notranslate"><span class="pre">Queue</span></code> from the standard library,
with a few additional features:</p>
<ul>
<li><p><a class="reference internal" href="api.html#skein.kv.EventQueue" title="skein.kv.EventQueue"><code class="xref py py-class docutils literal notranslate"><span class="pre">EventQueue</span></code></a> objects are iterable, allowing for easy looping of events:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Iterate through all events for keys starting with foobar</span>
<span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">app</span><span class="o">.</span><span class="n">kv</span><span class="o">.</span><span class="n">events</span><span class="p">(</span><span class="n">prefix</span><span class="o">=</span><span class="s1">&#39;foobar&#39;</span><span class="p">):</span>
    <span class="o">...</span>
</pre></div>
</div>
</li>
<li><p><a class="reference internal" href="api.html#skein.kv.EventQueue" title="skein.kv.EventQueue"><code class="xref py py-class docutils literal notranslate"><span class="pre">EventQueue</span></code></a> objects have additional methods
<a class="reference internal" href="api.html#skein.kv.EventQueue.subscribe" title="skein.kv.EventQueue.subscribe"><code class="xref py py-func docutils literal notranslate"><span class="pre">EventQueue.subscribe()</span></code></a> and <a class="reference internal" href="api.html#skein.kv.EventQueue.unsubscribe" title="skein.kv.EventQueue.unsubscribe"><code class="xref py py-func docutils literal notranslate"><span class="pre">EventQueue.unsubscribe()</span></code></a>, for
adding/removing subscriptions.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">eq</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">kv</span><span class="o">.</span><span class="n">event_queue</span><span class="p">()</span>
<span class="n">eq</span><span class="o">.</span><span class="n">subscribe</span><span class="p">(</span><span class="n">prefix</span><span class="o">=</span><span class="s1">&#39;service_1&#39;</span><span class="p">)</span>
<span class="n">eq</span><span class="o">.</span><span class="n">subscribe</span><span class="p">(</span><span class="n">prefix</span><span class="o">=</span><span class="s1">&#39;service_2&#39;</span><span class="p">)</span>

<span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">eq</span><span class="p">:</span>
    <span class="o">...</span>
</pre></div>
</div>
</li>
</ul>
<p>Internally, all <a class="reference internal" href="api.html#skein.kv.EventQueue" title="skein.kv.EventQueue"><code class="xref py py-class docutils literal notranslate"><span class="pre">EventQueue</span></code></a> objects are filled by the same worker
thread fed by a single client connection with the server. This helps minimize
the cost of creating additional event queues or subscribing to new event
ranges. When an <a class="reference internal" href="api.html#skein.kv.EventQueue" title="skein.kv.EventQueue"><code class="xref py py-class docutils literal notranslate"><span class="pre">EventQueue</span></code></a> object is collected, the event stream will
be automatically unsubscribed. To manually handle unsubscription you can also
use an event queue as a contextmanager, or call
<a class="reference internal" href="api.html#skein.kv.EventQueue.unsubscribe_all" title="skein.kv.EventQueue.unsubscribe_all"><code class="xref py py-func docutils literal notranslate"><span class="pre">EventQueue.unsubscribe_all()</span></code></a>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># All event filters will unsubscribe on exit from this block</span>
<span class="k">with</span> <span class="n">app</span><span class="o">.</span><span class="n">kv</span><span class="o">.</span><span class="n">event_queue</span><span class="p">()</span> <span class="k">as</span> <span class="n">eq</span><span class="p">:</span>
    <span class="n">eq</span><span class="o">.</span><span class="n">subscribe</span><span class="p">(</span><span class="n">prefix</span><span class="o">=</span><span class="s1">&#39;service_1&#39;</span><span class="p">)</span>
    <span class="n">eq</span><span class="o">.</span><span class="n">subscribe</span><span class="p">(</span><span class="n">prefix</span><span class="o">=</span><span class="s1">&#39;service_2&#39;</span><span class="p">)</span>

    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">event</span> <span class="o">=</span> <span class="n">eq</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
        <span class="o">...</span>

<span class="n">eq</span><span class="o">.</span><span class="n">subscribe</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;b&#39;</span><span class="p">)</span>
<span class="o">...</span>
<span class="c1"># explicitly unsubscribe from all event filters</span>
<span class="n">eq</span><span class="o">.</span><span class="n">unsubscribe_all</span><span class="p">()</span>
</pre></div>
</div>
<p>Iterating through the event queue or using methods like <a class="reference internal" href="api.html#skein.kv.EventQueue.get" title="skein.kv.EventQueue.get"><code class="xref py py-func docutils literal notranslate"><span class="pre">EventQueue.get()</span></code></a>
yield instances of <a class="reference internal" href="api.html#skein.kv.Event" title="skein.kv.Event"><code class="xref py py-class docutils literal notranslate"><span class="pre">Event</span></code></a> - a <code class="docutils literal notranslate"><span class="pre">namedtuple</span></code> containing</p>
<ul class="simple">
<li><p>The <code class="docutils literal notranslate"><span class="pre">key</span></code> affected</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">result</span></code> of the change. A <a class="reference internal" href="api.html#skein.kv.ValueOwnerPair" title="skein.kv.ValueOwnerPair"><code class="xref py py-class docutils literal notranslate"><span class="pre">ValueOwnerPair</span></code></a> if a PUT event, or
<code class="docutils literal notranslate"><span class="pre">None</span></code> if a DELETE event.</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">event_type</span></code> - either <code class="xref py py-data docutils literal notranslate"><span class="pre">EventType.PUT</span></code> or <code class="xref py py-data docutils literal notranslate"><span class="pre">EventType.DELETE</span></code>.</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">event_filter</span></code> that generated this event.</p></li>
</ul>
<p>Note that if a queue subscribes to any intersecting filters, events that fall
in the intersection will be placed in that queue once for every applicable
filter.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create a new event queue</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">eq</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">kv</span><span class="o">.</span><span class="n">event_queue</span><span class="p">()</span>

<span class="c1"># Create two filters that intersect</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">starts_with_apple</span> <span class="o">=</span> <span class="n">eq</span><span class="o">.</span><span class="n">subscribe</span><span class="p">(</span><span class="n">prefix</span><span class="o">=</span><span class="s1">&#39;apple&#39;</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">between_a_and_b</span> <span class="o">=</span> <span class="n">eq</span><span class="o">.</span><span class="n">subscribe</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;b&#39;</span><span class="p">)</span>

<span class="c1"># Create a new key starting with &#39;apple&#39;, triggering an event</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">app</span><span class="o">.</span><span class="n">kv</span><span class="p">[</span><span class="s1">&#39;applesauce&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;11.30&#39;</span>

<span class="c1"># One event is put in the queue for each filter, since both filters hit the</span>
<span class="c1"># key &#39;applesauce&#39;</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">eq</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
<span class="n">Event</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="s1">&#39;applesauce&#39;</span><span class="p">,</span>
      <span class="n">result</span><span class="o">=</span><span class="n">ValueOwnerPair</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="sa">b</span><span class="s1">&#39;11.30&#39;</span><span class="p">,</span> <span class="n">owner</span><span class="o">=</span><span class="kc">None</span><span class="p">),</span>
      <span class="n">event_type</span><span class="o">=</span><span class="n">EventType</span><span class="o">.</span><span class="n">PUT</span><span class="p">,</span>
      <span class="n">event_filter</span><span class="o">=</span><span class="n">EventFilter</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="s1">&#39;apple&#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;applf&#39;</span><span class="p">,</span> <span class="n">event_type</span><span class="o">=</span><span class="n">EventType</span><span class="o">.</span><span class="n">ALL</span><span class="p">))</span>

<span class="o">&gt;&gt;&gt;</span> <span class="n">eq</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
<span class="n">Event</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="s1">&#39;applesauce&#39;</span><span class="p">,</span>
      <span class="n">result</span><span class="o">=</span><span class="n">ValueOwnerPair</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="sa">b</span><span class="s1">&#39;11.30&#39;</span><span class="p">,</span> <span class="n">owner</span><span class="o">=</span><span class="kc">None</span><span class="p">),</span>
      <span class="n">event_type</span><span class="o">=</span><span class="n">EventType</span><span class="o">.</span><span class="n">PUT</span><span class="p">,</span>
      <span class="n">event_filter</span><span class="o">=</span><span class="n">EventFilter</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="n">event_type</span><span class="o">=</span><span class="n">EventType</span><span class="o">.</span><span class="n">ALL</span><span class="p">))</span>
</pre></div>
</div>
<div class="section" id="waiting-for-a-single-key">
<h4><a class="toc-backref" href="#id14">Waiting for a Single Key</a><a class="headerlink" href="#waiting-for-a-single-key" title="Permalink to this headline">¶</a></h4>
<p>One common case is waiting for a single key to be set. This might contain a
runtime configuration value that one container sets that others need, or it may
signal that a service has started up to other containers that depend on it. The
<a class="reference internal" href="api.html#skein.kv.KeyValueStore.wait" title="skein.kv.KeyValueStore.wait"><code class="xref py py-func docutils literal notranslate"><span class="pre">KeyValueStore.wait()</span></code></a> method is provided for this common case. It will
block until the key is set (usually by a different container).</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># In one container, block until the key is set, returning the value</span>
<span class="n">address</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">kv</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="s1">&#39;dask.scheduler.address&#39;</span><span class="p">)</span>

<span class="c1"># In another container set the key</span>
<span class="n">app</span><span class="o">.</span><span class="n">kv</span><span class="p">[</span><span class="s1">&#39;dask.scheduler.address&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;172.18.0.2:8787&#39;</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="example-atomic-counter">
<h2><a class="toc-backref" href="#id15">Example - Atomic Counter</a><a class="headerlink" href="#example-atomic-counter" title="Permalink to this headline">¶</a></h2>
<p>Using the primitives above, we can create larger concurrency abstractions. Here
we provide a simple recipe for an atomic shared counter.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">uuid</span>
<span class="kn">from</span> <span class="nn">contextlib</span> <span class="kn">import</span> <span class="n">contextmanager</span>

<span class="kn">import</span> <span class="nn">skein</span>

<span class="k">class</span> <span class="nc">Counter</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;An atomic counter class.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    kv : KeyValueStore</span>
<span class="sd">        The application key-value store.</span>
<span class="sd">    key : str, optional</span>
<span class="sd">        The key to use to store the counter state. If absent a new counter</span>
<span class="sd">        is created with a unique random key.</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    Create a new counter</span>

<span class="sd">    &gt;&gt;&gt; c = Counter(app.kv)</span>

<span class="sd">    Increment the counter temporarily</span>

<span class="sd">    &gt;&gt;&gt; with c.incrementing():</span>
<span class="sd">    ...     do_work()</span>

<span class="sd">    Block until the counter reaches 0</span>
<span class="sd">    &gt;&gt;&gt; c.wait_until_zero()</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">kv</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">key</span> <span class="o">=</span> <span class="n">key</span> <span class="ow">or</span> <span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()</span><span class="o">.</span><span class="n">hex</span>
        <span class="c1"># Get the current value, or set it to 0 if new.</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">kv</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">int</span><span class="o">.</span><span class="n">to_bytes</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="s1">&#39;little&#39;</span><span class="p">))</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">4</span><span class="p">:</span>
            <span class="c1"># The key already exists and isn&#39;t a valid counter</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Key isn&#39;t a valid counter&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">kv</span> <span class="o">=</span> <span class="n">kv</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">key</span> <span class="o">=</span> <span class="n">key</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">int</span><span class="o">.</span><span class="n">from_bytes</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kv</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">],</span> <span class="s1">&#39;little&#39;</span><span class="p">)</span>

    <span class="nd">@contextmanager</span>
    <span class="k">def</span> <span class="nf">incrementing</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Increment while inside a block&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">increment</span><span class="p">()</span>
            <span class="k">yield</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">decrement</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">increment</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Increment and return the new value&quot;&quot;&quot;</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="c1"># Try to increment atomically until success. Inefficient if high</span>
            <span class="c1"># increment/decrement rate, but fine for low bandwidth changes</span>
            <span class="n">current</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kv</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">]</span>
            <span class="n">new</span> <span class="o">=</span> <span class="p">(</span><span class="nb">int</span><span class="o">.</span><span class="n">from_bytes</span><span class="p">(</span><span class="n">current</span><span class="p">,</span> <span class="s1">&#39;little&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">new_bytes</span> <span class="o">=</span> <span class="n">new</span><span class="o">.</span><span class="n">to_bytes</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s1">&#39;little&#39;</span><span class="p">)</span>
            <span class="c1"># Only set the value to the new value if the value hasn&#39;t</span>
            <span class="c1"># changed between when we got it above and now</span>
            <span class="n">succeeded</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kv</span><span class="o">.</span><span class="n">transaction</span><span class="p">(</span>
                <span class="n">conditions</span><span class="o">=</span><span class="p">[</span><span class="n">skein</span><span class="o">.</span><span class="n">kv</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">)</span> <span class="o">==</span> <span class="n">current</span><span class="p">],</span>
                <span class="n">on_success</span><span class="o">=</span><span class="p">[</span><span class="n">skein</span><span class="o">.</span><span class="n">kv</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">,</span> <span class="n">new_bytes</span><span class="p">)])</span>
            <span class="k">if</span> <span class="n">succeeded</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">new</span>

    <span class="k">def</span> <span class="nf">decrement</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Decrement and return the new value&quot;&quot;&quot;</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="c1"># Try to decrement atomically until success. Inefficient if high</span>
            <span class="c1"># increment/decrement rate, but fine for low bandwidth changes</span>
            <span class="n">current</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kv</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">]</span>
            <span class="n">new</span> <span class="o">=</span> <span class="p">(</span><span class="nb">int</span><span class="o">.</span><span class="n">from_bytes</span><span class="p">(</span><span class="n">current</span><span class="p">,</span> <span class="s1">&#39;little&#39;</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">new_bytes</span> <span class="o">=</span> <span class="n">new</span><span class="o">.</span><span class="n">to_bytes</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s1">&#39;little&#39;</span><span class="p">)</span>
            <span class="c1"># Try to decrement atomically until success. Inefficient if high</span>
            <span class="c1"># increment/decrement rate, but fine for low bandwidth changes</span>
            <span class="n">succeeded</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kv</span><span class="o">.</span><span class="n">transaction</span><span class="p">(</span>
                <span class="n">conditions</span><span class="o">=</span><span class="p">[</span><span class="n">skein</span><span class="o">.</span><span class="n">kv</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">)</span> <span class="o">==</span> <span class="n">current</span><span class="p">],</span>
                <span class="n">on_success</span><span class="o">=</span><span class="p">[</span><span class="n">skein</span><span class="o">.</span><span class="n">kv</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">,</span> <span class="n">new_bytes</span><span class="p">)])</span>
            <span class="k">if</span> <span class="n">succeeded</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">new</span>

    <span class="k">def</span> <span class="nf">wait_for_zero</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Block until the counter equals 0&quot;&quot;&quot;</span>
        <span class="c1"># Watch the event stream for changes, waiting for the value to</span>
        <span class="c1"># decrement to 0</span>
        <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">kv</span><span class="o">.</span><span class="n">events</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">,</span> <span class="n">event_type</span><span class="o">=</span><span class="s1">&#39;PUT&#39;</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">int</span><span class="o">.</span><span class="n">from_bytes</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="s1">&#39;little&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span>
</pre></div>
</div>
</div>
</div>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<p class="logo">
  <a href="index.html">
    <img class="logo" src="_static/logo.svg" alt="Logo"/>
    
  </a>
</p>



<p class="blurb">A tool and library for easily deploying applications on Apache YARN</p>




<p>
<iframe src="https://ghbtns.com/github-btn.html?user=jcrist&repo=skein&type=watch&count=False&size=large&v=2"
  allowtransparency="true" frameborder="0" scrolling="0" width="200px" height="35px"></iframe>
</p>





    

<p>
<a class="badge" href="https://travis-ci.org/jcrist/skein">
    <img
        alt="https://secure.travis-ci.org/jcrist/skein.svg?branch=master"
        src="https://secure.travis-ci.org/jcrist/skein.svg?branch=master"
    />
</a>
</p>


<h3>Navigation</h3>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="quickstart.html">Quickstart</a></li>
<li class="toctree-l1"><a class="reference internal" href="specification.html">Specification</a></li>
<li class="toctree-l1"><a class="reference internal" href="distributing-files.html">Distributing Files</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Key-Value Store</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#overview">Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="#walkthrough">Walkthrough</a></li>
<li class="toctree-l2"><a class="reference internal" href="#example-atomic-counter">Example - Atomic Counter</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="web-ui.html">Web UI</a></li>
<li class="toctree-l1"><a class="reference internal" href="recipes.html">Recipes</a></li>
<li class="toctree-l1"><a class="reference internal" href="debugging.html">Debugging</a></li>
<li class="toctree-l1"><a class="reference internal" href="api.html">API Docs</a></li>
<li class="toctree-l1"><a class="reference internal" href="cli.html">CLI Docs</a></li>
<li class="toctree-l1"><a class="reference internal" href="changelog.html">Changelog</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="develop.html">Development</a></li>
</ul>

<h3>Need help?</h3>

<p>
  Open an issue in the <a href="https://github.com/jcrist/skein/issues">issue tracker</a>.
</p>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2018, Jim Crist-Harif.
      
      |
      <a href="_sources/key-value-store.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>